
# 基于Andriod环境的快速简单记事本设计

## 1 系统描述
### 1.1 问题说明
&emsp;&emsp;在生活中，记事本是常用的一种记录工具。传统记事本是用纸质材料做成的一本小册子。可以在上面写字或者绘图。但是纸质记事本十分不方便。纸质记事本需要占用一定的体积，而且还要配备一支笔，才能进行记事。另外，纸质记事本还需要消耗大量纸质，对环境造成损害。随着手机的普及，移动端的电子记事本应用也随之兴起。电子记事本可以嵌入到手机中，用户只需要下载一个应用，就能直接使用。用户不需要配备笔，就可以直接在手机上输入文字，可以直接保存在手机上。编辑和查看文字都十分方便。但是许多电子记事本应用只局限于记录文字，不能够进行绘图、照片和录音功能。为此，本次能力拓展训练，设计并实现一个快速简单记事本，要求支持文字、绘图、照片、录音，以满足不同用户的需求。

### 1.2 数据需求
![数据流图](https://github.com/MKcKr0/MyNote/tree/master/doc-image/数据流图.png)  
&emsp;&emsp;图表1为快速简单记事本系统的数据流图。该数据流图为事务型数据流图。数据变换型处理有“保存记事”和“读取记事”。“处理请求”为事务中心，由它接收用户的请求，并且将请求进行分发处理。图中“画图”和“拍照”处理得到的数据都为“图片”。这是因为，用户画图之后得到的图片和拍照得到的照片都是以图片形式存放。以下为数据流图中出现的主要数据结构或数据存储：
#### 1.2.1 记事
&emsp;&emsp;一个“记事”包含一个记事信息、多张图片、多个声音。从用户角度来看，用户可以将一个标题、一个文本内容、多张图片、多个声音添加到一个“记事”中。
#### 1.2.2 记事信息
&emsp;&emsp;保存一个“记事”的基本信息，包括记事的ID、顺序码、标题、文本内容、修改时间。因为记事之间的排列可能会影响用户的体验，系统根据顺心码来排列记事
#### 1.2.3 图片
&emsp;&emsp;拍照或者画图之后存放的图片文件。拍照之后得到的是以.jpg为后缀的JPEG文件。文件名格式为“JPG_YYYYMMDD_ NNNNNNNNNN.jpg”。其中YYYY为年份，MM为月份，DD为天数，NNNNNNNNNN为系统自动生成的10位阿拉伯数字。画图之后得到的是以.png为后缀的PNG文件，文件格式为“PNG_YYYYMMDD_ NNNNNNNNNN.jpg”。
#### 1.2.4 图片信息
&emsp;&emsp;保存关于图片的信息，包括图片的ID、关联的记事信息ID和保存路径。系统可以通过图片信息找到图片的保存路径，对图片进行操作。
#### 1.2.5 声音
&emsp;&emsp;录音之后存放的音频文件，主要是以.wav为后缀的WAVE文件。文件名格式为“WAV_YYYYMMDD_ NNNNNNNNNN.wav”。
#### 1.2.6 声音信息
&emsp;&emsp;保存关于声音的信息，包括声音的ID、关联的记事信息ID和保存路径。声音的时长、格式等媒体信息可以直接从“声音”文件中直接得到。这样系统只需要找到声音文件的保存路径就可以得到声音文件的所有媒体信息。

### 1.3 功能需求
&emsp;&emsp;快速简单记事本系统有六个主要功能，分别为记录文本、画图功能、记录声音、记录图片、查看图片和播放声音。详细功能需求描述如下：
#### 1.3.1 记录文本
&emsp;&emsp;用户可以添加记事的标题和内容。文本信息持久化保存到数据库中。当用户下次打开记事本时，还能查看之前添加的标题和内容。用户还可以删除和修改记事。如果用户修改记事时，将标题和内容设置为空，系统自动将空的记事舍弃。每次用户修改之后，系统更新修改时间，并更新排序码，将刚刚修改后的记事放到首位。根据局部性原理，用户刚刚访问的记事，在最近一段时间内可能还会访问。如果用户不想使用这一特性，用户还可以自己调整记事的顺序。长按一个记事，再将其拖拽到合适的位置，就可以改变记事的顺序。
#### 1.3.2 画图功能
&emsp;&emsp;用户打开画图界面后，可以用手指在屏幕上滑动来画图。用户可以选择画笔的颜色和粗细。还可以使用橡皮擦来擦除错误的笔划。与记录文本类似，系统检测用户画图完成之后的图片是否为空。如果为空，自动舍弃。
#### 1.3.3 记录声音
&emsp;&emsp;用户选择“声音”功能之后，可以选择添加声音的方式，可以是录音或者从文件系统中选择音频文件。如果选择录音，系统显示录音界面，用户点击录音按钮，系统开始录音，计时器也开始工作。并将录音时间实时显示在界面上。录音完成之后用户可以再次点击录音按钮停止录音。之后，用户可以选择保存录音，或者选择取消录音，或者再次点击录音按钮重新开始录音。
#### 1.3.4 记录图片
&emsp;&emsp;用户选择“图片”功能之后，可以选择添加图片的方式，可以是拍照或者从文件系统中选择图片文件。如果选择拍照，系统调起系统相机进行拍照。完成拍照后，用户可以选择取消、保存或重新拍照。
#### 1.3.5 查看图片
&emsp;&emsp;用户点击一张图片的缩略图，系统全屏显示这张缩略图的原图。用户可以选择删除图片，或者在这张图的基础上进行画图操作。
#### 1.3.6 播放声音
&emsp;&emsp;用户点击一个声音的文件名，系统显示声音播放界面，并且开始播放声音文件。用户还可以在播放界面中选择暂停或者继续播放声音。在播放界面中，显示了声音文件的各种基本媒体信息，并且显示了进度条和播放时长。用户可以拖动进度条，来控制播放进度。

## 2 系统设计
### 2.1 总体设计
&emsp;&emsp;采用MVC架构，Android应用开发过程中出现的XML文件可视为视图层，各种视图对应的事件处理程序可视为控制层。另外，采用Android Room框架进行数据持久化，对应的实体类可视为模型层。因此，在设计过程中不需要额外地定义各种模块层次。
![功能模块图](https://github.com/MKcKr0/MyNote/tree/master/doc-image/功能模块图.bmp)  
&emsp;&emsp;如图表2所示，根据需求描述，可以对系统模块进行划分。图中“权限申请”指的是向Android系统申请权限的操作。“数据库基本操作”指的是对本地SQLite数据库的基本操作，如打开、关闭数据库等。“文件处理工具”指的是与文件相关的工具，比如复制文件、创建模板文件、获得特定文件的Uri等操作。

### 2.2 数据库表结构
&emsp;&emsp;在本系统中，图片和声音存储在文件中。需要存储在SQLite数据库中的数据有记事信息、图片信息、声音信息。
![E-R图](https://github.com/MKcKr0/MyNote/tree/master/doc-image/ER图.bmp)  
&emsp;&emsp;从E-R图中可以看到一个Note可以对应多个Image和Sound。可以将Note的id分别设置为Image和Sound的外键。得到如下数据库表结构：

表名：tb_note

|字段名|对象数据类型|SQLite数据类型|主外键|说明|约束|
|-|-|-|-|-|-|
|id|int|INTEGER|主键|ID|非空，自增|
|order|int|INTEGER|无|顺序码|非空|
|title|String|TEXT|无|标题|无|
|body|String|TEXT|无|文本内容|无|
|timestamp|Date|INTEGER|无|修改时间|非空|

表名：tb_image

|字段名|对象数据类型|SQLite数据类型|主外键|说明|约束|
|-|-|-|-|-|-|
|id	int|INTEGER|主键|ID|非空，自增|
|note_id|int|INTEGER|外键|引用Note的id|非空|
|path|String|TEXT|无|路径|无|

表名：tb_sound

|字段名|对象数据类型|SQLite数据类型|主外键|说明|约束|
|-|-|-|-|-|-|
|id|int|INTEGER|主键|ID|非空，自增|
|note_id|int|INTEGER|外键|引用Note的id|非空|
|path|String|TEXT|无|路径|无|

&emsp;&emsp;上面的数据库表中对象数据类型指的是字段在对应的实体类中的数据类型。在Android Room框架中，数据库操作都进行了封装，可以实现从实体类到数据库表的映射，而屏蔽了底层的SQLite数据类型。

### 2.3 输入/输出设计
#### 2.3.1 画图输入/输出设计
&emsp;&emsp;画图功能需要实时输入和输出，即用户的手机触摸屏幕上的画布时，相应的笔划要显示出来。定义一个Bitmap对象作为画布，在Bitmap上构建一个Canvas对象，使用Canvas对象进行绘图，相应的修改被应用到Bitmap对象中。这样，用户画出的图就被保存到Bitmap对象中。  
&emsp;&emsp;但是要做到实时显示，还需要重写控件的OnDraw()函数，使用控件的Canvas对控件进行绘图。因此需要自定义一个类继承AppCompactView，重写OnDraw()函数。并且使用OnTouchEvent()函数来监听触摸事件，获得触摸点的坐标，进行绘图。

#### 2.3.2 照片输入/输出设计
&emsp;&emsp;照片从Android系统相机中输入，从屏幕中输出。调用系统相机之前需要获得相机拍照权限。然后使用创建一个Intent，添加照片存放的Uri。使用startActivityForResult()函数调用系统相机。用户拍照完成或者取消后，系统调用onActivityResult()回调函数，获得拍照结果。如果拍照成功，resultCode返回RESULT_OK，如果拍照取消，则返回RESULT_CANCEL。  
&emsp;&emsp;使用ImageView显示照片，但是尺寸太大，不过直接放入，则会占满整个屏幕。因此，应该先调用ThumbnailUtils.extractThumbnail()函数，获得图片的缩略图，再使用ImageView显示。

#### 2.3.2 声音输入/输出设计
&emsp;&emsp;使用AudioRecord进行录音。在录音之前，先创建一个WAVE文件，作为保存录音的文件。再为AudioRecord设置缓冲区。只要缓冲区为空，AudioRecord就会将音频数据放入到缓冲区中。所以，在录音过程中，需要开启一个额外的线程从缓冲区中读取音频数据，再写入到WAVE文件中。在录音完毕之后，得到的音频文件是无法直接播放的PCM文件。因此，在创建WAVE之后，立即写入44字节空数据，进行占位。录音完毕之后，再写入44字节的WAVE头信息，这样就能得到WAVE文件。  
&emsp;&emsp;使用MediaPlayer播放声音文件。在播放声音之前，需要先用MediaMetadataRetriever获得音频文件的媒体信息，并将其显示出来。在播放声音时，需要实时显示进度。设置一个进度条SeekBar来显示播放进度，使用TextView显示现在已经播放的时长。由于Android在编译时对线程进行检测，不能直接使用Java中的Timer模型，进行定时刷新。因此，使用Android中的Handler模型，递归调用postDelayed()函数刷新时长。

### 2.4 用户界面设计
#### 2.4.1 主界面设计
![主界面](https://github.com/MKcKr0/MyNote/tree/master/doc-image/主界面.bmp)  
&emsp;&emsp;图表7所示为快速简单记事本主界面。图中黑色边框为界面边界，不属于设计范围。在主界面每一个记事都做成了卡片样式。界面顶部是应用工具栏，不同界面的应用工具栏拥有相似的外观。底部是功能工具栏，不同的界面有不同的按钮组。

#### 2.4.2 记事编辑界面
![记事](https://github.com/MKcKr0/MyNote/tree/master/doc-image/记事.bmp)
&emsp;&emsp;在记事编辑界面中，用户可以点击底部的画图按钮进行绘图。可以点击声音按钮进行录音，点击照片按钮进行照相。底部工具栏还显示了记事的修改时间。添加的图片会直接在此界面中显示出来。

#### 2.4.3 画图界面设计
![画图](https://github.com/MKcKr0/MyNote/tree/master/doc-image/画图.bmp)  
在画图界面中间是画布区域，用户可以在上面画图。底部工具栏有颜色选择器，用户可以选择画笔的颜色。还有粗细选择器，用户可以选择画笔的粗细。还有“橡皮擦”和“笔”这两个单选按钮，用户可以使用橡皮擦进行擦除。

#### 2.4.4 录音界面设计
![录音](https://github.com/MKcKr0/MyNote/tree/master/doc-image/录音.bmp)  
&emsp;&emsp;在录音界面中有一个显示时间控件Chronometer，显示了当前录音的时长。中间的话筒图标是录音按钮，可以控制录音的开始与停止。底部有取消录音和保存录音的按钮。
#### 2.4.5 播放声音界面设计
![播放](https://github.com/MKcKr0/MyNote/tree/master/doc-image/播放.bmp)  
&emsp;&emsp;播放声音界面中显示了音频文件的各种媒体信息，如歌曲名、时长和歌曲缩略图。绿色按钮可以控制声音的播放、暂停和回复。红色按钮可以停止声音的播放。进度条和当前播放时长显示了播放进度。滑动进度条，可以控制播放进度。

### 2.5 处理过程设计
#### 2.5.1 记事排序算法设计
&emsp;&emsp;tb_note中的order字段作为一个排序码，用来规定Note的顺序。这个排序码只是作为一个相对顺序。不使用timestamp作为排序码的原因是，用户可能希望在不修改Note的情况下改变Note的顺序。排序原则有两条：系统自动根据修改时间降序排列Note，用户可以手动修改排序。  
&emsp;&emsp;显示Note的时候，是根据order降序排列。使用SQL查询语句，可以使用“order by desc”将结果降序排列。显示Note不需要做其它额外处理。  
&emsp;&emsp;添加Note的时候，新添加的Note的修改时间是最新的，应该把它添加到最上方的位置，排序码最大。在数据集中找到最大的order，再加1即为新Note的排序码。  
&emsp;&emsp;删除Note的时候，由于order只表示相对顺序。直接删除一条Note，不影响其它Note的相对顺序。因此，也不需要做额外出来。  
&emsp;&emsp;修改Note的时候，Note的修改时间也变为最新，直接将其order变为数据集中最大order+1  
&emsp;&emsp;移动Note的时候，不能直接将看作是先删除再插入。因为，插入的位置可能没有间隙。相邻的两个Note的order可能相连。因此需要将原位置到目的位置之间的所有Note进行重新分配。  

#### 2.5.2 实时画图算法设计
&emsp;&emsp;实时画图是通过OnTouchEvent()函数来检测用户的触屏事件。Path是Android的内置对象，可以用来保存一系列的点。当Canvas在绘制Path对象时，会对条折线进行抗锯齿优化，使用户感觉这是一条曲线。由于每次控件的Canvas在OnDraw()方法中绘制，都会清除以前绘制的图像。因此，需要保存所有的路径和颜色。一条路径对应一个颜色。定义一个内部类Line，保存一条路径和一个对应的颜色。在定义一个ArrayList<Line>保存所有的笔划。  
&emsp;&emsp;当用户接触屏幕时，说明这是一条路径的开始。在ArrayList<Line>中添加一个Line。其路径为空，颜色为画笔颜色。  
&emsp;&emsp;当用户在屏幕上滑动或者离开屏幕时，说明要把当前点添加到最新的路径中。在ArrayList<Line>的最后一个Line中添加一个点。由于要做到实时显示，因此调用invalidate()函数，使控件调用OnDraw()重绘，将新的线显示出来。  

## 3 系统实现和测试
### 3.1 测试用例描述
#### 3.1.1 添加记事测试用例设计
|输入|预期输出|
|-|-|
|空白记事|提示舍弃空白记事，数据库中没有相应的记录|
|添加标题和内容|显示标题和内容，数据库中有相应的记录|
#### 3.1.2 删除记事测试用例设计
|输入|预期输出|
|-|-|
|删除第一条记事|记事从控件中删除，数据库中没有相应记录|
|删除中间的记事|记事从控件中删除，数据库中没有相应记录|
|删除最后一条记事|记事从控件中删除，数据库中没有相应记录|
##### 3.1.3 修改记事测试用例设计
|输入|预期输出
|-|-|
|修改第一条记事|控件中的记事被修改，数据库相应记录也被修改|
|修改中间的记事|控件中的记事被修改，数据库相应记录也被修改|
|修改最后一条记事|控件中的记事被修改，数据库相应记录也被修改|
|将一条记事的清空|提示舍弃空白记事，数据库中没有相应的记录|
### 3.2 测试方法
&emsp;&emsp;采用的测试方法主要是黑盒测试和白盒测试相结合的方法。对于简单的逻辑结构，直接使用黑盒测试。对于复杂的逻辑结构，采用白盒测试。在集成测试方面，采用自底向上的测试方法。每次实现完一个子模块，就集成到系统中进行测试。
### 3.3 测试结果
&emsp;&emsp;在测试用例描述中测试用例，在一开始的时候，出现了错误。在经过反复调试之后，错误得到解决。以上测试用例全部通过。

## 4 设计总结
### 4.1 设计特点
&emsp;&emsp;本系统中在界面设计方面，显示一条记事信息使用了CardView，然后将多个CardView放在了一个RecyclerView中。可以同过ReyclerView的适配器，绑定数据。修改数据之后，直接使用适配器修改RecyclerView，而且还会自动显示修改动画。比如：插入、删除、修改和移动动画。
&emsp;&emsp;在数据库设计方面，使用了Android官方推荐的框架。它是一种对SQLite的封装。只需要定义实体类、DAO类和数据库类，就可以将实体对象保存到SQLite文件中。而且DAO类只需要编写方法签名，与Java注解中的SQL语句关联起来，就可以直接使用。在实体类中还可以定义各种数据库表的约束，如：主键、外键、自增字段、级联删除等，提高了开发效率。
&emsp;&emsp;在功能设计方面，设计并实现了文本记事、画图、照相、录音等功能。每条Note都能够删除、修改和移动。画图功能提供颜色选择器，系统预置了16种颜色供用户选择。还提供了笔划宽度选择器，预置了三种宽度。这些功能可以满足用户基本的需求。
### 4.2 设计不足
&emsp;&emsp;在本次设计中还存在一些不足之处，如播放声音功能没有全部实现。只实现了播放声音界面和基本的逻辑。没有很好地将其集成到系统中，进行使用。查看图片功能没有全部实现，只能查看图片的缩略图。画图的功能太少，没有框选功能和其它常用的画图功能。设计的时间十分仓促，无法全部一一实现。另外，还可以加入一种待办事件列表，用户可以使用这个列表来安排事件。
### 4.3 设计收获和体会
&emsp;&emsp;在这次能力拓展训练中，我的各方面的能力都得到了提高。在此之前，我完全没有开发安卓应用的经验。在本次系统设计中，大部分的知识都是通过在Android官网文档中学到的。由于时间有限，无法了解Android的内部机制。很多知识还不懂。但是，通过自己一步步的尝试，基本完成了这个快速简单记事本的设计和开发。通过这次开发，我发现很多知识都是相通的，在Android中使用XML实现视图。在网页开发中也是使用HTML实现视图。如果掌握了一种技术，学习一种类似的技术就不是很难。但是，我在进行Android多线程编程时，遇到了很多困难。其它编程语言的并发模型，我没有什么了解。Android的多线程模型，也没理解清楚，开发过程中出现各种异常。因此，学习并精通一种语言非常重要。
